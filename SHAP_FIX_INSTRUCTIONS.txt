# CRITICAL FIX FOR SHAP
# =====================
# In app_enhanced.py, find the SHAP section (Tab 3) around line 360-380

# REPLACE THIS BLOCK:
"""
if st.button('💡 Generate SHAP Explanations'):
    with st.spinner('Computing SHAP values...'):
        try:
            signals_df = st.session_state.signals
            X = signals_df[['case_count', 'prr', 'ror', 'chi2']].fillna(0)
            feature_names = ['case_count', 'prr', 'ror', 'chi2']
            
            analyzer = SHAPAnalyzer()
            
            if hasattr(st.session_state.trained_model, 'model'):
                model = st.session_state.trained_model.model
            elif hasattr(st.session_state.trained_model, 'shard_models'):
                model = st.session_state.trained_model.shard_models[0]
            
            analyzer.compute_shap_values(model, X, feature_names=feature_names)
"""

# WITH THIS NEW BLOCK:
"""
if st.button('💡 Generate SHAP Explanations'):
    # Check feature pipeline exists
    if not hasattr(st.session_state.trained_model, 'feature_pipeline'):
        st.error('❌ Feature pipeline not found. Please retrain the model first.')
        st.stop()
    
    with st.spinner('Computing SHAP values...'):
        try:
            signals_df = st.session_state.signals
            feature_pipeline = st.session_state.trained_model.feature_pipeline
            
            # CRITICAL: Use feature pipeline to transform data
            X = feature_pipeline.transform(signals_df)
            
            st.info(f'📊 Using {len(feature_pipeline.feature_names)} features: {feature_pipeline.feature_names}')
            
            analyzer = SHAPAnalyzer()
            
            # Get model
            if hasattr(st.session_state.trained_model, 'model'):
                model = st.session_state.trained_model.model
            elif hasattr(st.session_state.trained_model, 'shard_models'):
                model = st.session_state.trained_model.shard_models[0]
            else:
                st.error('Model structure incompatible')
                st.stop()
            
            # SHAP computation with transformed data
            analyzer.compute_shap_values(model, X)
"""

