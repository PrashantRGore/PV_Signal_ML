"""
PV_Signal_ML Enhanced System
Main Streamlit Application with SISA, SHAP, and Multi-Source Data
"""
import streamlit as st
import pandas as pd
import mlflow
from pathlib import Path
import config
from src.data.data_source_manager import DataSourceManager
from src.stats_engine.disproportionality import DisproportionalityAnalysis
from src.ml.sisa_trainer import SISATrainer
from src.explainability.shap_analysis import SHAPAnalyzer
from src.utils.logger import setup_logger

logger = setup_logger(__name__)

# ===== PAGE CONFIG =====
st.set_page_config(
    page_title="PV Signal ML - Enhanced",
    page_icon="🔬",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ===== DISCLAIMER =====
st.warning(config.DISCLAIMER_TEXT)

# ===== TITLE =====
st.title("🔬 Pharmacovigilance Signal Detection with SISA & SHAP")
st.markdown("**Enhanced System with Machine Unlearning and Explainable AI**")

# ===== SESSION STATE INITIALIZATION =====
if 'data_loaded' not in st.session_state:
    st.session_state.data_loaded = False
if 'signals' not in st.session_state:
    st.session_state.signals = None
if 'trained_model' not in st.session_state:
    st.session_state.trained_model = None

# ===== DATA SOURCE MANAGER =====
data_manager = DataSourceManager()
source_type = data_manager.select_data_source()

# Load data based on source
data = None
if source_type == "local":
    data = data_manager.load_local_dataset()
elif source_type == "demo_hf":
    data = data_manager.load_demo_dataset()
elif source_type == "faers_live":
    data = data_manager.load_faers_dataset()

if data is not None:
    st.session_state.data_loaded = True
    st.session_state.raw_data = data
    st.session_state.metadata = data_manager.get_metadata()
    
    # Display metadata
    st.sidebar.success(f"✅ Data loaded: {len(data):,} records")
    with st.sidebar.expander("📋 Data Metadata"):
        st.json(data_manager.get_metadata())

# ===== MAIN TABS =====
if st.session_state.data_loaded:
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "🔍 Signal Detection", 
        "🤖 ML Validation", 
        "💡 Explainability", 
        "📊 Reports",
        "🗑️ Unlearning"
    ])
    
    # TAB 1: SIGNAL DETECTION
    with tab1:
        st.header("Statistical Signal Detection")
        
        if st.button("🚀 Run Signal Detection", type="primary"):
            with st.spinner("Computing disproportionality signals..."):
                stats_engine = DisproportionalityAnalysis()
                signals = stats_engine.compute_signals(st.session_state.raw_data)
                st.session_state.signals = signals
            
            st.success(f"✅ Detected {len(signals)} signals")
        
        if st.session_state.signals is not None:
            st.subheader("Top Signals")
            
            # Filter controls
            col1, col2 = st.columns(2)
            with col1:
                prr_threshold = st.slider("PRR Threshold", 1.0, 10.0, 2.0, 0.1)
            with col2:
                min_cases = st.slider("Min Case Count", 3, 50, 3)
            
            # Filter signals
            filtered = st.session_state.signals[
                (st.session_state.signals['prr'] >= prr_threshold) &
                (st.session_state.signals['case_count'] >= min_cases)
            ]
            
            st.dataframe(
                filtered[['drug_name', 'event_term', 'case_count', 'prr', 'prr_lower', 'prr_upper', 'chi2', 'is_signal_prr']],
                use_container_width=True
            )
            
            # Download button
            csv = filtered.to_csv(index=False)
            st.download_button(
                "📥 Download Signals CSV",
                csv,
                "signals.csv",
                "text/csv"
            )
    
    # TAB 2: ML VALIDATION
    with tab2:
        st.header("ML-Based Signal Validation (SISA)")
        
        st.info("""
        **SISA (Sharded, Isolated, Sliced, Aggregated) Training**
        - Enables efficient machine unlearning for GDPR compliance
        - Trains ensemble of models on data shards
        - Allows removal of individual cases without full retraining
        """)
        
        if st.session_state.signals is not None:
            col1, col2 = st.columns(2)
            with col1:
                enable_sisa = st.checkbox("Enable SISA Training", value=config.ENABLE_SISA)
            with col2:
                num_shards = st.number_input("Number of Shards", 5, 20, config.NUM_SHARDS)
            
            if st.button("🤖 Train ML Model", type="primary"):
                with st.spinner("Training SISA ensemble..."):
                    # Prepare features (simplified for demo)
                    signals_df = st.session_state.signals
                    X = signals_df[['case_count', 'prr', 'ror', 'chi2']].fillna(0)
                    y = signals_df['is_signal_prr'].astype(int)
                    case_ids = signals_df['drug_name'] + '_' + signals_df['event_term']
                    
                    if enable_sisa:
                        trainer = SISATrainer(num_shards=num_shards)
                        metadata = trainer.train(X, y, case_ids)
                        st.session_state.trained_model = trainer
                        
                        st.success("✅ SISA training complete!")
                        st.json(metadata)
                    else:
                        st.warning("SISA disabled - using standard training")
        else:
            st.warning("⚠️ Run signal detection first (Tab 1)")
    
    # TAB 3: EXPLAINABILITY
    with tab3:
        st.header("Model Explainability (SHAP)")
        
        if st.session_state.trained_model is not None:
            if st.button("💡 Generate SHAP Explanations"):
                with st.spinner("Computing SHAP values..."):
                    signals_df = st.session_state.signals
                    X = signals_df[['case_count', 'prr', 'ror', 'chi2']].fillna(0)
                    
                    analyzer = SHAPAnalyzer()
                    
                    # Get first shard model for demo
                    model = st.session_state.trained_model.shard_models[0]
                    analyzer.compute_shap_values(model, X)
                    
                    # Generate global summary
                    summary = analyzer.generate_global_summary()
                    
                    st.success("✅ SHAP analysis complete!")
                    
                    # Display global summary
                    st.subheader("Global Feature Importance")
                    st.image(summary['summary_plot'])
                    
                    # Display top features
                    st.subheader("Top Features")
                    top_features = pd.DataFrame(summary['top_features'])
                    st.dataframe(top_features, use_container_width=True)
        else:
            st.warning("⚠️ Train ML model first (Tab 2)")
    
    # TAB 4: REPORTS
    with tab4:
        st.header("Signal Assessment Reports")
        
        if st.session_state.signals is not None:
            st.markdown("**Generate SAR (Signal Assessment Report)**")
            
            selected_signal = st.selectbox(
                "Select Signal",
                options=st.session_state.signals.head(20).apply(
                    lambda x: f"{x['drug_name']} - {x['event_term']}", axis=1
                )
            )
            
            if st.button("📄 Generate SAR"):
                st.info("SAR generation coming soon - will integrate RAG engine")
        else:
            st.warning("⚠️ No signals available")
    
    # TAB 5: UNLEARNING
    with tab5:
        st.header("Machine Unlearning (GDPR Right to be Forgotten)")
        
        st.markdown("""
        **SISA Unlearning Process:**
        1. Enter Case ID to remove
        2. System identifies affected data shard
        3. Retrain only affected shard from last checkpoint
        4. Update ensemble without full retraining
        """)
        
        if st.session_state.trained_model is not None:
            case_id = st.text_input("Enter Case ID to Unlearn")
            
            if st.button("🗑️ Unlearn Case"):
                if case_id:
                    with st.spinner(f"Unlearning case {case_id}..."):
                        result = st.session_state.trained_model.unlearn(case_id)
                        
                    if result['status'] == 'unlearned':
                        st.success(f"✅ Case {case_id} successfully unlearned!")
                        st.json(result)
                    else:
                        st.warning(f"Case {case_id} not found in training data")
                else:
                    st.error("Please enter a case ID")
        else:
            st.warning("⚠️ Train SISA model first (Tab 2)")

else:
    st.info("👈 Select a data source from the sidebar to begin")

# ===== FOOTER =====
st.sidebar.markdown("---")
st.sidebar.markdown(f"**Version:** {config.VALIDATION_STATUS['code_version']}")
st.sidebar.markdown(f"**MLflow:** {config.MLFLOW_TRACKING_URI}")
